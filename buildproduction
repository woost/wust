#!/bin/bash -e

echo "installing node dependencies..."
npm install

echo "installing bower dependencies..."
bower --config.interactive=false install

[ -s "$HOME/.rvm/scripts/rvm" ] && source "$HOME/.rvm/scripts/rvm"

echo "linting production assets..."
node_modules/jshint/bin/jshint assets

echo "running tests..."
sbt clean test

echo "building production assets..."
./prodassets

echo "building play application..."
sbt stage

echo "building docker image..."
version="$(sbt version | grep -Eo '[0-9]+\.[0-9]+(-SNAPSHOT)?' | tail -n 1)" # TODO: better?
if [ -z "$version" ]; then
    echo "No version found. No docker image built."
    exit 1
fi
docker build . --tag woost/wust:latest --tag woost/wust:$version
